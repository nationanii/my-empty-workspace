#!/bin/bash
set -u
# =====================================================================
# TinyCore Deployer v9-Diagnostic
# - Tự động kiểm tra xem Link có phải là GZIP xịn không
# - Nếu là HTML (Google Drive warning), nó sẽ báo lỗi và hiện nội dung
# - Gửi toàn bộ log chi tiết (Header/Content) lên Discord
# =====================================================================

# === USER CONFIG =====================================================
GZ_LINK="http://drive.muavps.net/windows/Windows10_Lite.gz"
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1460967132761423913/8cPQaQCrlvc-0CWC7VpM30bKr1ulMPUrCFZAUr7r06VPqFkbgCvCRbuyde_Ffc-0joff"
SWAP_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/grubsdbuefiwin.gz"

# === SETUP ENV =======================================================
TCE_MIRROR="http://tinycorelinux.net/14.x/x86_64"
BOOT_DIR="/boot/tinycore"
WORKDIR="/tmp/tinycore_initrd"
KERNEL_PATH="$BOOT_DIR/vmlinuz64"
INITRD_PATH="$BOOT_DIR/corepure64.gz"
INITRD_PATCHED="$BOOT_DIR/corepure64-v9diag.gz"
BUSYBOX_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/busybox"

export DEBIAN_FRONTEND=noninteractive
echo 'kexec-tools kexec-tools/load_kexec boolean true' | debconf-set-selections

echo "[1/5] Installing deps..."
apt-get -y -qq update
apt-get -y -qq install wget curl gzip cpio kexec-tools parted gdisk ca-certificates --no-install-recommends

mkdir -p "$BOOT_DIR" "$WORKDIR"

echo "[2/5] Fetch TinyCore..."
wget -q -O "$KERNEL_PATH" "$TCE_MIRROR/release/distribution_files/vmlinuz64"
wget -q -O "$INITRD_PATH" "$TCE_MIRROR/release/distribution_files/corepure64.gz"

echo "[3/5] Unpack & Inject..."
cd "$WORKDIR"
gzip -dc "$INITRD_PATH" | cpio -idmv >/dev/null 2>&1
mkdir -p "$WORKDIR/srv" "$WORKDIR/opt"
wget -q -O "$WORKDIR/srv/busybox" "$BUSYBOX_URL"
chmod +x "$WORKDIR/srv/busybox"

# --- DIAGNOSTIC SCRIPT ---
cat > "$WORKDIR/opt/bootlocal.sh" <<'EOS'
#!/bin/sh
# ERROR HANDLING: Manual
IMAGE_URL="__TC_GZ_LINK__"
DISCORD_WEBHOOK="__TC_DISCORD__"
SWAP_URL="__TC_SWAP_URL__"

# Helper: Log & Discord
safe_echo() { echo "$1" | sed 's/"/\\"/g'; }
post_discord() {
  [ -z "$DISCORD_WEBHOOK" ] && return 0
  echo "$1" | awk -v max=1800 '{line=$0;while(length(line)>max){print substr(line,1,max);line=substr(line,max+1)}print line}' |
  while read -r chunk; do
    [ -z "$chunk" ] && continue
    curl -m 5 -sS -H "Content-Type: application/json" \
      -d "{\"content\":\"\`\`\`$(safe_echo "$chunk")\`\`\`\"}" \
      "$DISCORD_WEBHOOK" >/dev/null 2>&1 || true
    sleep 0.2
  done
}
log(){ echo "$1"; echo "$1" >> /srv/lab; post_discord "$1"; }

mkdir -p /srv
touch /srv/lab

# 1. NET & PACKAGES
log "[INIT] Starting v9-Diagnostic..."
for pkg in ca-certificates.tcz openssl.tcz curl.tcz openssh.tcz parted gdisk; do
  su tc -c "tce-load -wi $pkg" >> /srv/lab 2>&1
done
/usr/local/etc/init.d/openssh start >/dev/null 2>&1

# DHCP
killall -q udhcpc
for nic in $(ls /sys/class/net | grep -v lo); do
  ip link set "$nic" up
  udhcpc -b -i "$nic" >>/srv/lab 2>&1 &
done
sleep 5

# 2. CHECK CONNECTIVITY
if ! ping -c 1 -W 2 8.8.8.8 >/dev/null 2>&1; then
  log "[FATAL] No Internet. Cannot proceed."
  sleep 10; reboot -f
fi

# 3. PRE-FLIGHT: LINK CHECK (QUAN TRỌNG NHẤT)
log "[CHECK] Analyzing URL: $IMAGE_URL"

# Lấy Header để xem server trả về gì
log "[CHECK] Fetching HTTP Headers..."
curl -I -L -k "$IMAGE_URL" > /srv/headers.txt 2>&1
cat /srv/headers.txt | grep -E "HTTP/|Content-Type|Location" >> /srv/lab
cat /srv/headers.txt | grep -E "HTTP/|Content-Type|Location" | while read l; do post_discord "[HEADER] $l"; done

# Kiểm tra Magic Bytes (2 byte đầu tiên của file)
# GZIP bắt buộc phải là 1f 8b
log "[CHECK] Checking Magic Bytes..."
MAGIC=$(curl -L -k -r 0-1 -s "$IMAGE_URL" | hexdump -e '1/1 "%02x"')

if [ "$MAGIC" = "1f8b" ]; then
  log "[PASS] Valid GZIP detected (Magic: 1f8b)."
else
  log "[FAIL] URL IS NOT GZIP! Magic detected: '$MAGIC'"
  log "[FAIL] Server sent HTML or Text instead of .img.gz"
  log "[DEBUG] Downloading first 5 lines of content to see what it is..."
  curl -L -k -r 0-500 -s "$IMAGE_URL" | head -n 5 > /srv/preview.txt
  cat /srv/preview.txt >> /srv/lab
  post_discord "CONTENT PREVIEW:\n$(cat /srv/preview.txt)"
  
  log "[ACTION] Aborting install to protect disk."
  sleep 30
  reboot -f
fi

# 4. DISK SETUP
TARGET=""
for d in /dev/sdb /dev/vdb /dev/nvme1n1 /dev/sda; do [ -b "$d" ] && TARGET="$d" && break; done
[ -z "$TARGET" ] && TARGET="/dev/sda"
log "[DISK] Target: $TARGET"
umount $(mount | grep "$TARGET" | awk '{print $1}') 2>/dev/null
swapoff -a

# 5. EXECUTE PIPELINE (Chỉ chạy khi Magic Byte OK)
log "[DEPLOY] Starting Stream..."
(
  set -o pipefail
  curl -L -k -f "$IMAGE_URL" 2> /srv/curl_err \
  | gunzip -c 2> /srv/gunzip_err \
  | dd of="$TARGET" bs=1M 2> /srv/dd_err
)
RC=$?

if [ "$RC" -eq 0 ]; then
  log "[SUCCESS] Image deployed."
  sync
  partprobe "$TARGET"
else
  log "[ERR] Pipeline failed (rc=$RC)"
  log "--- CURL ERROR ---"
  cat /srv/curl_err | tail -n 2 | while read l; do log "$l"; done
  log "--- GUNZIP ERROR ---"
  cat /srv/gunzip_err | tail -n 2 | while read l; do log "$l"; done
  sleep 10
  reboot -f
fi

# 6. BOOTFIX
BOOTDISK="/dev/sda"
if [ "$BOOTDISK" != "$TARGET" ]; then
    log "[BOOTFIX] Patching MBR on $BOOTDISK..."
    curl -L -k -o /tmp/grub.gz "$SWAP_URL"
    gunzip -c /tmp/grub.gz | dd of="$BOOTDISK" bs=4M || true
fi

log "[SYS] Rebooting..."
reboot -f
EOS

sed -i "s#__TC_GZ_LINK__#${GZ_LINK}#g"   "$WORKDIR/opt/bootlocal.sh"
sed -i "s#__TC_DISCORD__#${DISCORD_WEBHOOK}#g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s#__TC_SWAP_URL__#${SWAP_URL}#g" "$WORKDIR/opt/bootlocal.sh"
chmod +x "$WORKDIR/opt/bootlocal.sh"

echo "/opt/bootlocal.sh &" >> "$WORKDIR/etc/init.d/tc-config"

echo "[4/5] Repacking..."
find . | cpio -o -H newc | gzip -c > "$INITRD_PATCHED"

echo "[5/5] Kexec..."
kexec -l "$KERNEL_PATH" --initrd="$INITRD_PATCHED" --command-line="console=ttyS0 quiet"
kexec -e
