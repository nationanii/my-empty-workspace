#!/bin/bash
set -euo pipefail
# =====================================================================
# TinyCore Auto Windows Deployer v7-netfix-stable-bootfix
# - DHCP th·∫≠t v·ªõi udhcpc (default.script), kh√¥ng -s /dev/null
# - T·∫£i image qua wget (theo redirect), stream gunzip | dd (BusyBox-safe)
# - Theo d√µi dd qua pidof + /proc/$pid/fdinfo/1 (offset), no infinite loop
# - Ch·ªçn ƒëƒ©a ƒë√≠ch an to√†n (∆∞u ti√™n /dev/sdb, tr√°nh ghi l√™n disk ƒëang boot)
# - Unmount to√†n b·ªô ph√¢n v√πng c·ªßa ƒëƒ©a ƒë√≠ch; sync+sleep tr∆∞·ªõc khi dd
# - Bootfix an to√†n: n·∫øu ƒëƒ©a boot ‚â† ƒëƒ©a ƒë√≠ch, ghi MBR/bootsector (SWAP_URL)
# =====================================================================

# === USER CONFIG =====================================================
GZ_LINK="https://148.100.76.25:3923/WindowsCustom.gz"   # file .img.gz (c√≥ redirect OK)
DISCORD_WEBHOOK="https://discord.com/api/webhooks/1460967132761423913/8cPQaQCrlvc-0CWC7VpM30bKr1ulMPUrCFZAUr7r06VPqFkbgCvCRbuyde_Ffc-0joff"
SWAP_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/grubsdbuefiwin.gz"  # bootfix (MBR/bootsector)

# === NETWORK =====================================================

# H·ªèi kernel: Interface n√†o ƒëang k·∫øt n·ªëi t·ªõi Google DNS?
# L·ªánh n√†y s·∫Ω b·ªè qua br-, docker0, tun0... v√† tr·∫£ v·ªÅ interface th·∫≠t (vd: eth0, ens3, ens5)
MAIN_IF=$(ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -n1)

# L·∫•y th√¥ng tin t·ª´ Interface ƒê√É L·ªåC
MY_IP=$(ip -4 addr show "$MAIN_IF" | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+' | head -n1)
MY_GW=$(ip route | grep default | grep "$MAIN_IF" | awk '{print $3}' | head -n1)
MY_DNS="8.8.8.8"

if [ -z "$MAIN_IF" ] || [ -z "$MY_IP" ] || [ -z "$MY_GW" ]; then
  echo "[FATAL] Could not detect WAN Network. Is curl/ping blocked?"
  echo "DEBUG: IF=$MAIN_IF / IP=$MY_IP / GW=$MY_GW"
  exit 1
fi

echo "[NETWORK] Selected NIC: $MAIN_IF"
echo "[NETWORK] Config to pass: IP=$MY_IP | GW=$MY_GW"

# T·∫°o chu·ªói bootcmd
CMD_IP="STATIC_IP=${MY_IP} STATIC_GW=${MY_GW} STATIC_DNS=${MY_DNS}"



# === TINYCORE BOOT ARTIFACTS =========================================
TCE_VERSION="14.x"
ARCH="x86_64"
TCE_MIRROR="http://tinycorelinux.net"
BOOT_DIR="/boot/tinycore"
WORKDIR="/tmp/tinycore_initrd"
KERNEL_URL="$TCE_MIRROR/$TCE_VERSION/$ARCH/release/distribution_files/vmlinuz64"
INITRD_URL="$TCE_MIRROR/$TCE_VERSION/$ARCH/release/distribution_files/corepure64.gz"
KERNEL_PATH="$BOOT_DIR/vmlinuz64"
INITRD_PATH="$BOOT_DIR/corepure64.gz"
INITRD_PATCHED="$BOOT_DIR/corepure64-v7netfix-stable-bootfix.gz"
BUSYBOX_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/busybox"

export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a
echo 'kexec-tools kexec-tools/load_kexec boolean true' | debconf-set-selections

echo "[1/6] Installing deps..."
apt-get -y -qq update
apt-get -y -qq install wget curl gzip cpio kexec-tools parted gdisk ca-certificates --no-install-recommends

mkdir -p "$BOOT_DIR" "$WORKDIR"

echo "[2/6] Fetch TinyCore kernel/initrd..."
wget -q -O "$KERNEL_PATH" "$KERNEL_URL"
wget -q -O "$INITRD_PATH" "$INITRD_URL"

echo "[3/6] Unpack initrd..."
cd "$WORKDIR"
gzip -dc "$INITRD_PATH" | cpio -idmv

echo "[4/6] Inject bootlocal.sh + tools..."
mkdir -p "$WORKDIR/srv"
echo "pre-boot: initrd patched, waiting TinyCore..." > "$WORKDIR/srv/lab"
wget -q -O "$WORKDIR/srv/busybox" "$BUSYBOX_URL"
chmod +x "$WORKDIR/srv/busybox"

cat > "$WORKDIR/opt/bootlocal.sh" <<'EOS'
#!/bin/sh
IMAGE_URL="__TC_GZ_LINK__"
DISCORD_WEBHOOK="__TC_DISCORD__"
SWAP_URL="__TC_SWAP_URL__"
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

# L·∫•y tham s·ªë m·∫°ng t·ª´ Host truy·ªÅn v√†o
for x in $(cat /proc/cmdline); do
  case "$x" in
    STATIC_IP=*) MANUAL_IP="${x#*=}" ;;
    STATIC_GW=*) MANUAL_GW="${x#*=}" ;;
    STATIC_DNS=*) MANUAL_DNS="${x#*=}" ;;
  esac
done

safe_echo() { echo "$1" | sed 's/"/\\"/g'; }
post_discord() {
  [ -z "$DISCORD_WEBHOOK" ] && return 0
  echo "$1" | awk -v max=1800 '{line=$0;while(length(line)>max){print substr(line,1,max);line=substr(line,max+1)}print line}' |
  while read -r chunk; do
    [ -z "$chunk" ] && continue
    curl -m 5 -sS -H "Content-Type: application/json" \
      -d "{\"content\":\"\`\`\`$(safe_echo "$chunk")\`\`\`\"}" \
      "$DISCORD_WEBHOOK" >/dev/null 2>&1 || true
    sleep 0.2
  done
}
log(){ echo "$1" | tee -a /srv/lab >/dev/null; post_discord "$1"; }

# HTTP heartbeat
[ -d /srv ] || mkdir -p /srv
touch /srv/lab
chmod +x /srv/busybox
/srv/busybox httpd -p 80 -h /srv &
( while true; do date >> /srv/lab; sleep 5; done ) &
log "[BOOT] BusyBox HTTP :80 up (v7-netfix-stable-bootfix)"
log "[SYS] $(uname -a)"
log "[SYS] cmdline: $(cat /proc/cmdline 2>/dev/null)"

# Packages (sequential)
for pkg in ca-certificates.tcz openssl.tcz curl.tcz openssh.tcz parted gdisk; do
  su tc -c "tce-load -wi $pkg" >> /srv/lab 2>&1 || log "[PKG] warn: $pkg load nonzero"
done
/usr/local/etc/init.d/openssh start >/dev/null 2>&1 && log "[PKG] SSH started" || true

# --- NETWORK SETUP (TINYCORE SIDE) ---
# Trong TinyCore m·ªõi boot (RAM), Docker KH√îNG t·ªìn t·∫°i.
# br-xxx kh√¥ng c√≥, ch·ªâ c√≥ lo v√† eth0 (do ta d√πng net.ifnames=0)
log "[NET] Configuring Network..."
ifconfig lo up
ip link set eth0 up

# 1. Th·ª≠ d√πng c·∫•u h√¨nh tƒ©nh t·ª´ Host 
if [ -n "$MANUAL_IP" ]; then
  log "[NET] Applying Host Config (Bypass DHCP): $MANUAL_IP via $MANUAL_GW"
  ip addr flush dev eth0
  ip addr add "$MANUAL_IP" dev eth0
  ip route add default via "$MANUAL_GW"
  echo "nameserver $MANUAL_DNS" > /etc/resolv.conf
else
  # Fallback DHCP
  log "[NET] No static config found, trying DHCP..."
  udhcpc -b -i eth0 -t 5 -T 3 >/dev/null 2>&1
fi

sleep 2
if ping -c 1 -W 2 8.8.8.8 >/dev/null 2>&1; then 
  log "[NET] Online! Ready to download."
else 
  log "[FATAL] Network Unreachable. Check Gateway settings."
fi

# Disk detect ‚Äî ∆ØU TI√äN /dev/sdb ƒë·ªÉ tr√°nh ghi l√™n disk ƒëang boot
log "[DISK] Detecting target..."
TARGET=""
for d in /dev/nvme0n1 ; do [ -b "$d" ] && TARGET="$d" && break; done
[ -z "$TARGET" ] && TARGET="$(lsblk -dno NAME,TYPE 2>/dev/null | awk '$2=="disk"{print $1}' | head -n1 | awk '{print "/dev/"$1}')"
[ -z "$TARGET" ] && { log "[ERR] No disk. Rebooting in 3s..."; sleep 3; reboot -f; }
log "[DISK] Using: $TARGET"
lsblk "$TARGET" -o NAME,SIZE,TYPE,MOUNTPOINT 2>/dev/null | sed 's/^/[LSBLK] /' >> /srv/lab

# Unmount m·ªçi ph√¢n v√πng c·ªßa TARGET
for m in $(mount | awk -v t="$TARGET" '$1 ~ t{print $3}'); do
  umount -f "$m" 2>/dev/null || true
done
sync; sleep 3

# X√°c ƒë·ªãnh boot-disk (ƒëƒ©a hi·ªán ch·ª©a /boot ho·∫∑c root)
BOOTDISK="$(lsblk -no PKNAME "$(readlink -f /dev/root 2>/dev/null || echo /dev/nvme0n1)" 2>/dev/null | sed 's#^#/dev/#')"
[ -z "$BOOTDISK" ] && BOOTDISK="/dev/nvme0n1"
log "[DISK] Boot-disk guessed: $BOOTDISK"

# Debug redirect chain (kh√¥ng fail n·∫øu l·ªói)
log "[IMG] Checking redirect chain (wget --spider -S)..."
wget --no-check-certificate --max-redirect=20 -S --spider "$IMAGE_URL" 2>>/srv/lab >/dev/null || true

# --- STREAM IMAGE: wget | gunzip | dd (BusyBox-safe, no infinite loop) ---
log "[IMG] Start streaming: wget -> gunzip -> dd"
log "[IMG] PIPE: wget -S -O- \"$IMAGE_URL\" | gunzip -c | dd of=\"$TARGET\" bs=4M conv=fsync"

(
  wget --no-check-certificate -S -O- "$IMAGE_URL" 2>>/srv/lab \
  | gunzip -c \
  | dd of="$TARGET" bs=4M conv=fsync 2>>/srv/lab
) &
PIPE_PID=$!

# monitor dd progress b·∫±ng offset (fdinfo)
i=0
while kill -0 "$PIPE_PID" 2>/dev/null; do
  PID_DD="$(pidof dd 2>/dev/null | awk '{print $1}')"
  if [ -n "$PID_DD" ] && [ -r "/proc/$PID_DD/fdinfo/1" ]; then
    OFFSET="$(awk '/pos:/{print $2}' /proc/$PID_DD/fdinfo/1 2>/dev/null | head -n1)"
    [ -z "$OFFSET" ] && OFFSET=0
    echo "[IMG] Installing... (${i}s, offset=$OFFSET)" >>/srv/lab
  else
    echo "[IMG] Installing... (${i}s)" >>/srv/lab
  fi
  sleep 5; i=$((i+5))
done

  log "[EXPAND] Fixing Partition Table..."
  
  # 1. Fix GPT Backup Header Location (Chuy·ªÉn header t·ª´ gi·ªØa ƒëƒ©a xu·ªëng cu·ªëi ƒëƒ©a)
  # sgdisk -e l√† l·ªánh th·∫ßn th√°nh ƒë·ªÉ s·ª≠a l·ªói n√†y
  if sgdisk -e "$TARGET" >> /srv/lab 2>&1; then
      log "[EXPAND] GPT Header moved to end of disk."
  else
      log "[WARN] sgdisk failed (Maybe MBR disk?). Trying parted fix..."
      # Trick: Parted print s·∫Ω h·ªèi fix -> ta ch·ªçn Ignore ho·∫∑c Fix.
      # ·ªû ƒë√¢y ta d√πng l·ªánh print ƒë·ªÉ force kernel ƒë·ªçc l·∫°i
      parted -s "$TARGET" print >/dev/null 2>&1 || true
  fi
  
  partprobe "$TARGET" || true
  sleep 2
  
  # 2. FIND LAST PARTITION (T√¨m ph√¢n v√πng cu·ªëi c√πng)
  # parted -m output: 1:1049kB:106MB:105MB:fat32:EFI System:boot,esp;
  # Ta l·∫•y d√≤ng cu·ªëi c√πng, c·∫Øt l·∫•y c·ªôt 1
  LAST_PART_NUM=$(parted -m "$TARGET" print 2>/dev/null | tail -n 1 | awk -F: '{print $1}')
  
  if [ -n "$LAST_PART_NUM" ] && [ "$LAST_PART_NUM" -gt 0 ]; then
      log "[EXPAND] Detected Last Partition: #$LAST_PART_NUM"
      log "[EXPAND] Resizing Partition #$LAST_PART_NUM to 100%..."
      
      parted -s "$TARGET" resizepart "$LAST_PART_NUM" 100% >> /srv/lab 2>&1
      
      log "[EXPAND] Resize command sent."
  else
      log "[ERR] Could not detect partition number. Skipping resize."
  fi

# l·∫•y exit code c·ªßa pipeline (dd l√† ti·∫øn tr√¨nh cu·ªëi c√πng tr·∫£ rc)
wait "$PIPE_PID"
RC=$?
if [ "$RC" -ne 0 ]; then
  log "[ERR] dd/wget pipeline failed (rc=$RC). Dump tail logs."
  tail -n 50 /srv/lab >>/srv/lab
  reboot -f
fi

sync
partprobe "$TARGET" 2>/dev/null || true
lsblk "$TARGET" -o NAME,SIZE,TYPE 2>/dev/null | sed 's/^/[POST] /' >> /srv/lab
log "[OK] Image deployed to $TARGET in ${i}s"

# --- BOOTFIX (ch·ªâ khi boot-disk kh√°c v·ªõi TARGET) ---
if [ "$BOOTDISK" != "$TARGET" ] && [ -b "$BOOTDISK" ]; then
  log "[BOOTFIX] Applying boot sector from SWAP_URL to $BOOTDISK (not target)"
  wget --no-check-certificate -O /tmp/grub.gz "$SWAP_URL" >>/srv/lab 2>&1 || true
  if [ -s /tmp/grub.gz ]; then
    gunzip -c /tmp/grub.gz | dd of="$BOOTDISK" bs=4M 2>>/srv/lab || true
    sync
    log "[BOOTFIX] MBR/bootsector written to $BOOTDISK"
  else
    log "[BOOTFIX] Failed to download grub.gz"
  fi
else
  log "[BOOTFIX] Skipped (boot-disk == target or boot-disk missing)"
fi

sleep 3
log "[SYS] Rebooting..."
reboot -f
EOS

# Inject runtime vars
sed -i "s#__TC_GZ_LINK__#${GZ_LINK}#g"   "$WORKDIR/opt/bootlocal.sh"
sed -i "s#__TC_DISCORD__#${DISCORD_WEBHOOK}#g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s#__TC_SWAP_URL__#${SWAP_URL}#g" "$WORKDIR/opt/bootlocal.sh"
chmod +x "$WORKDIR/opt/bootlocal.sh"

# Ensure autorun
grep -q "/opt/bootlocal.sh" "$WORKDIR/etc/init.d/tc-config" || echo "/opt/bootlocal.sh &" >> "$WORKDIR/etc/init.d/tc-config"

echo "[5/6] Repack initrd..."
find . | cpio -o -H newc | gzip -c > "$INITRD_PATCHED"

echo "[6/6] Kexec TinyCore..."
CMDLINE="console=ttyS0 quiet net.ifnames=0 biosdevname=0 $CMD_IP"
kexec -l "$KERNEL_PATH" --initrd="$INITRD_PATCHED" --command-line="$CMDLINE"
echo "===================================================="
echo "üöÄ TinyCore v7.1"
echo "===================================================="
echo "ok bye"
sleep 2
kexec -e
