#!/bin/bash
set -euo pipefail

# ==============================================================================
# TinyCore Fast Windows Deployer v9 (Public IP Support + GoTTY)
# ==============================================================================

# --- CẤU HÌNH ---
IMAGE_URL="https://148.100.76.25:3923/WindowsCustom.gz"   # Link file .img.gz (Windows)
GOTTY_PORT="80"                    # Port web terminal (Đảm bảo Firewall mở port này)

# ==============================================================================
# BƯỚC 1: LẤY THÔNG TIN MẠNG (QUAN TRỌNG)
# ==============================================================================
echo "[1/6] Detecting Network & Disk..."

# 1.1 Lấy Public IP (Để hiển thị link truy cập)
# Chúng ta lấy IP này TRƯỚC khi vào TinyCore để tránh việc vào đó không curl được
PUBLIC_IP=$(curl -s -4 --connect-timeout 5 https://ifconfig.me || curl -s -4 https://api.ipify.org)
[ -z "$PUBLIC_IP" ] && PUBLIC_IP="Unknown"
echo " -> Public IP detected: $PUBLIC_IP"

# 1.2 Lấy thông tin Interface nội bộ (Để cấu hình card mạng)
# Bắt buộc phải dùng thông tin này thì VPS mới có mạng (đặc biệt là AWS/GCP/Azure)
MAIN_IFACE=$(ip route show default | awk '/default/ {print $5}' | head -n1)
LOCAL_IP=$(ip -4 addr show "$MAIN_IFACE" | grep -oP '(?<=inet\s)\d+(\.\d+){3}' | head -n1)
GATEWAY=$(ip route show default | awk '/default/ {print $3}' | head -n1)

# Tính Netmask
CIDR=$(ip -4 addr show "$MAIN_IFACE" | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+' | head -n1 | awk -F'/' '{print $2}')
cdr2mask () {
   set -- $(( 5 - ($1 / 8) )) 255 255 255 255 $(( (255 << (8 - ($1 % 8))) & 255 )) 0 0 0
   [ $1 -gt 1 ] && shift $1 || shift
   echo ${1-0}.${2-0}.${3-0}.${4-0}
}
NETMASK=$(cdr2mask "$CIDR")
DNS_SERVER="8.8.8.8"

echo " -> Internal Config: IP=$LOCAL_IP | GW=$GATEWAY | Mask=$NETMASK"

# 1.3 Xác định ổ đĩa cài đặt (Tránh ghi nhầm)
ROOT_DEVICE=$(findmnt / -o SOURCE -n -k)
TARGET_DISK=$(lsblk -no PKNAME "$ROOT_DEVICE" | head -n1)
# Xử lý nvme0n1p1 -> nvme0n1
if [[ "$TARGET_DISK" == "" ]]; then TARGET_DISK=$(echo "$ROOT_DEVICE" | sed 's/[0-9]*$//'); fi
if [[ "$TARGET_DISK" != /dev/* ]]; then TARGET_DISK="/dev/$TARGET_DISK"; fi
echo " -> Target Disk: $TARGET_DISK"

# ==============================================================================
# BƯỚC 2: CHUẨN BỊ TOOL
# ==============================================================================
echo "[2/6] Downloading tools..."
export DEBIAN_FRONTEND=noninteractive
apt-get -y -qq update
apt-get -y -qq install wget curl gzip cpio kexec-tools ca-certificates

WORKDIR="/tmp/tc_deploy"
rm -rf "$WORKDIR" && mkdir -p "$WORKDIR"
BOOT_DIR="/boot/tinycore_deploy"
mkdir -p "$BOOT_DIR"

# Tải Kernel TinyCore
TCE_MIRROR="http://tinycorelinux.net/14.x/x86_64/release/distribution_files"
wget -q -O "$BOOT_DIR/vmlinuz64" "$TCE_MIRROR/vmlinuz64"
wget -q -O "$BOOT_DIR/corepure64.gz" "$TCE_MIRROR/corepure64.gz"

# Tải GoTTY (Static Binary)
wget -q -O "$WORKDIR/gotty.tar.gz" "https://github.com/yudai/gotty/releases/download/v1.0.1/gotty_linux_amd64.tar.gz"
tar xf "$WORKDIR/gotty.tar.gz" -C "$WORKDIR"
chmod +x "$WORKDIR/gotty"

# ==============================================================================
# BƯỚC 3: TẠO INITRD MỚI
# ==============================================================================
echo "[3/6] Injecting scripts into RAMDisk..."
cd "$WORKDIR"
mkdir -p unpack
cd unpack
gzip -dc "$BOOT_DIR/corepure64.gz" | cpio -idmv >/dev/null 2>&1

# Copy GoTTY
cp "$WORKDIR/gotty" usr/bin/

# Tạo script chạy tự động
cat > opt/bootlocal.sh <<EOF
#!/bin/sh
# --- VARIABLES ---
TARGET_DISK="${TARGET_DISK}"
LOCAL_IP="${LOCAL_IP}"
NETMASK="${NETMASK}"
GATEWAY="${GATEWAY}"
DNS="${DNS_SERVER}"
PUBLIC_IP="${PUBLIC_IP}"
IMAGE_URL="${IMAGE_URL}"
PORT="${GOTTY_PORT}"
# -----------------

LOGFILE="/tmp/install.log"

# 1. Cấu hình mạng (Dùng thông tin nội bộ để kết nối Gateway)
ifconfig eth0 \$LOCAL_IP netmask \$NETMASK up
route add default gw \$GATEWAY
echo "nameserver \$DNS" > /etc/resolv.conf

# 2. Bắt đầu ghi log
echo "==================================================" > \$LOGFILE
echo " TINYCORE INSTALLER - GOTTY MODE" >> \$LOGFILE
echo "==================================================" >> \$LOGFILE
echo " [NETWORK] Local IP: \$LOCAL_IP" >> \$LOGFILE
echo " [NETWORK] Public IP: \$PUBLIC_IP" >> \$LOGFILE
echo " [DISK] Target: \$TARGET_DISK" >> \$LOGFILE
echo " [INFO] Access this terminal at: http://\$PUBLIC_IP:\$PORT" >> \$LOGFILE
echo "==================================================" >> \$LOGFILE

# 3. Chạy GoTTY (Bind 0.0.0.0 để Public IP truy cập được)
# -w false: Chỉ xem, không gõ lệnh
# -a 0.0.0.0: Lắng nghe mọi kết nối (Quan trọng cho NAT)
gotty -a 0.0.0.0 -p "\$PORT" -w false tail -f \$LOGFILE &

# 4. Thực thi cài đặt
echo "[STEP 1] Unmounting disks..." >> \$LOGFILE
umount \$TARGET_DISK* 2>/dev/null
swapoff -a

echo "[STEP 2] Downloading & Writing Image..." >> \$LOGFILE
echo "Source: \$IMAGE_URL" >> \$LOGFILE
echo "Writing to: \$TARGET_DISK (bs=64M)" >> \$LOGFILE

# Pipeline siêu tốc: Wget -> Gunzip -> DD
wget --no-check-certificate -qO- "\$IMAGE_URL" \\
| gunzip -c \\
| dd of="\$TARGET_DISK" bs=64M conv=fsync 2>> \$LOGFILE

if [ \$? -eq 0 ]; then
    echo "" >> \$LOGFILE
    echo "SUCCESS! System rebooting in 10s..." >> \$LOGFILE
    sleep 10
    reboot -f
else
    echo "" >> \$LOGFILE
    echo "ERROR! Installation failed." >> \$LOGFILE
    sleep 3600
fi
EOF

chmod +x opt/bootlocal.sh

# Đóng gói lại
find . | cpio -o -H newc | gzip -c > "$BOOT_DIR/corepure64-custom.gz"

# ==============================================================================
# BƯỚC 4: KEXEC
# ==============================================================================
echo "[4/6] Config loaded."
echo "========================================================"
echo " CHUẨN BỊ CÀI ĐẶT QUA RAM"
echo " ----------------------------------------------------"
echo " 1. Sau khi chạy lệnh này, kết nối SSH sẽ mất."
echo " 2. Mở trình duyệt truy cập ngay vào:"
echo "    http://$PUBLIC_IP:$GOTTY_PORT"
echo " ----------------------------------------------------"
echo "========================================================"
echo "Booting TinyCore in 3 seconds..."
sleep 3

CMDLINE="console=tty0 quiet"
kexec -l "$BOOT_DIR/vmlinuz64" --initrd="$BOOT_DIR/corepure64-custom.gz" --command-line="$CMDLINE"
kexec -e
