#!/bin/bash
set -euo pipefail

# ==============================================================================
# TinyCore Fast Windows Deployer v8 (GoTTY + NetClone + HostDiskDetect)
# ==============================================================================

# --- CẤU HÌNH ---
IMAGE_URL="https://148.100.76.25:3923/WindowsCustom.gz"  # Link file .img.gz
PORT="80"                         # Port để xem GoTTY (Mặc định port 80 - web)

# ==============================================================================
# BƯỚC 1: THU THẬP THÔNG TIN TỪ HOST (MẠNG + DISK)
# ==============================================================================
echo "[1/6] Gathering Host Config..."

# 1.1 Xác định ổ đĩa chính (Đĩa đang chứa phân vùng root /)
# Lệnh này tìm device của thư mục /, sau đó tìm đĩa cha (loại bỏ partition number)
ROOT_DEVICE=$(findmnt / -o SOURCE -n -k)
TARGET_DISK=$(lsblk -no PKNAME "$ROOT_DEVICE" | head -n1)
# Xử lý trường hợp NVMe (vd: nvme0n1p1 -> nvme0n1) hoặc sda1 -> sda
if [[ "$TARGET_DISK" == "" ]]; then TARGET_DISK=$(echo "$ROOT_DEVICE" | sed 's/[0-9]*$//'); fi
# Đảm bảo có /dev/ prefix
if [[ "$TARGET_DISK" != /dev/* ]]; then TARGET_DISK="/dev/$TARGET_DISK"; fi

echo " -> Target Disk Detected: $TARGET_DISK"

# 1.2 Lấy thông tin mạng tĩnh
MAIN_IFACE=$(ip route show default | awk '/default/ {print $5}' | head -n1)
MY_IP=$(ip -4 addr show "$MAIN_IFACE" | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
MY_GW=$(ip route show default | awk '/default/ {print $3}' | head -n1)
# Tính Netmask từ CIDR (đơn giản hóa bằng python hoặc tính toán bash)
CIDR=$(ip -4 addr show "$MAIN_IFACE" | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+' | head -n1 | awk -F'/' '{print $2}')
cdr2mask () {
   set -- $(( 5 - ($1 / 8) )) 255 255 255 255 $(( (255 << (8 - ($1 % 8))) & 255 )) 0 0 0
   [ $1 -gt 1 ] && shift $1 || shift
   echo ${1-0}.${2-0}.${3-0}.${4-0}
}
MY_MASK=$(cdr2mask "$CIDR")
MY_DNS=$(grep -v '^#' /etc/resolv.conf | grep nameserver | awk '{print $2}' | head -n1)
[ -z "$MY_DNS" ] && MY_DNS="8.8.8.8"

echo " -> Network Cloned: IP=$MY_IP | GW=$MY_GW | Mask=$MY_MASK | DNS=$MY_DNS"

# ==============================================================================
# BƯỚC 2: CHUẨN BỊ MÔI TRƯỜNG & TẢI FILE
# ==============================================================================
echo "[2/6] Installing dependencies & Downloading files..."
export DEBIAN_FRONTEND=noninteractive
apt-get -y -qq update
apt-get -y -qq install wget curl gzip cpio kexec-tools ca-certificates

WORKDIR="/tmp/tc_builder"
rm -rf "$WORKDIR" && mkdir -p "$WORKDIR"
BOOT_DIR="/boot/tinycore_deploy"
mkdir -p "$BOOT_DIR"

# Tải TinyCore Kernel & Initrd
TCE_MIRROR="http://tinycorelinux.net/14.x/x86_64/release/distribution_files"
wget -q -O "$BOOT_DIR/vmlinuz64" "$TCE_MIRROR/vmlinuz64"
wget -q -O "$BOOT_DIR/corepure64.gz" "$TCE_MIRROR/corepure64.gz"

# Tải GoTTY (Static binary)
# Sử dụng phiên bản v1.0.1 cũ nhưng ổn định và static
echo " -> Downloading GoTTY..."
wget -q -O "$WORKDIR/gotty.tar.gz" "https://github.com/yudai/gotty/releases/download/v1.0.1/gotty_linux_amd64.tar.gz"
tar xf "$WORKDIR/gotty.tar.gz" -C "$WORKDIR"
chmod +x "$WORKDIR/gotty"

# ==============================================================================
# BƯỚC 3: MOD INITRD (INJECT SCRIPT & TOOLS)
# ==============================================================================
echo "[3/6] Modifying Initrd..."
cd "$WORKDIR"
mkdir -p unpack
cd unpack
gzip -dc "$BOOT_DIR/corepure64.gz" | cpio -idmv >/dev/null 2>&1

# Copy GoTTY vào bin
cp "$WORKDIR/gotty" usr/bin/

# Tạo script bootlocal.sh (Chạy khi TinyCore khởi động)
cat > opt/bootlocal.sh <<EOF
#!/bin/sh
# --- VARS INJECTED FROM HOST ---
TARGET_DISK="${TARGET_DISK}"
IP_ADDR="${MY_IP}"
NETMASK="${MY_MASK}"
GATEWAY="${MY_GW}"
DNS_SERVER="${MY_DNS}"
IMAGE_URL="${IMAGE_URL}"
PORT="${PORT}"
# -------------------------------

LOGfile="/tmp/install.log"
touch \$LOGfile

# 1. Cấu hình mạng (Static - Nhanh & Ổn định)
echo "[NET] Configuring static network..." >> \$LOGfile
ifconfig eth0 \$IP_ADDR netmask \$NETMASK up
route add default gw \$GATEWAY
echo "nameserver \$DNS_SERVER" > /etc/resolv.conf
echo "nameserver 8.8.4.4" >> /etc/resolv.conf

# 2. Khởi chạy GoTTY (Chế độ xem log)
# -w false: Không cho phép input
# -p: Port
echo "[GOTTY] Starting Web Terminal on port \$PORT..." >> \$LOGfile
gotty -p "\$PORT" -w false tail -f \$LOGfile &

echo "[INFO] ------------------------------------------------" >> \$LOGfile
echo "[INFO]  TINYCORE INSTALLER IS RUNNING" >> \$LOGfile
echo "[INFO]  PLEASE WATCH THIS TERMINAL. DO NOT CLOSE." >> \$LOGfile
echo "[INFO]  TARGET DISK: \$TARGET_DISK" >> \$LOGfile
echo "[INFO] ------------------------------------------------" >> \$LOGfile

# 3. Chuẩn bị Disk
echo "[DISK] Unmounting partitions on \$TARGET_DISK..." >> \$LOGfile
umount \$TARGET_DISK* 2>/dev/null
swapoff -a

# 4. Tải và Ghi Image (Tối ưu tốc độ)
echo "[INSTALL] Starting download & write..." >> \$LOGfile
echo "[INSTALL] Pipeline: wget -> gunzip -> dd (bs=64M)" >> \$LOGfile

# Dùng wget stream thẳng vào dd
# conv=fsync: Đảm bảo dữ liệu được ghi vật lý trước khi kết thúc
# status=progress: (Busybox dd có thể không hỗ trợ, nên ta dùng pipe log size)

wget --no-check-certificate -qO- "\$IMAGE_URL" \\
| gunzip -c \\
| dd of="\$TARGET_DISK" bs=64M conv=fsync 2>> \$LOGfile

EXIT_CODE=\$?

if [ \$EXIT_CODE -eq 0 ]; then
    echo "" >> \$LOGfile
    echo "[SUCCESS] Installation Complete!" >> \$LOGfile
    echo "[SYS] Rebooting in 5 seconds..." >> \$LOGfile
    sleep 5
    reboot -f
else
    echo "" >> \$LOGfile
    echo "[ERROR] Installation FAILED. Check logs above." >> \$LOGfile
    # Giữ terminal sống để debug
    sleep 3600
fi
EOF

chmod +x opt/bootlocal.sh

# Đóng gói lại Initrd
echo "[4/6] Repacking Initrd..."
find . | cpio -o -H newc | gzip -c > "$BOOT_DIR/corepure64-custom.gz"

# ==============================================================================
# BƯỚC 4: KEXEC (CHUYỂN KERNEL)
# ==============================================================================
echo "[5/6] Preparing Kexec..."

# Cmdline tối giản
CMDLINE="console=tty0 quiet"

echo "========================================================"
echo " PRE-FLIGHT CHECK:"
echo " IP: $MY_IP"
echo " Disk: $TARGET_DISK"
echo " Viewer: http://$MY_IP:$PORT"
echo "========================================================"
echo "[6/6] Executing Kexec. GOOD LUCK!"
sleep 2

kexec -l "$BOOT_DIR/vmlinuz64" \
      --initrd="$BOOT_DIR/corepure64-custom.gz" \
      --command-line="$CMDLINE"

kexec -e
