#!/bin/bash
set -euo pipefail

# =====================================================================
# TinyCore Deployer v8-gotty-static-speed
# - Monitor: GoTTY (Realtime Web Terminal)
# - Network: Static IP (Inherit from Host) - No DHCP waiting
# - Disk: Auto-detect Root Disk on Host -> Pass to TinyCore
# - Optimization: Minimal extensions, Pre-downloaded binaries
# =====================================================================

# === CONFIG ==========================================================
GZ_LINK="https://is.gd/ZubYbG"   # Link file .img.gz
GOTTY_URL="https://github.com/yudai/gotty/releases/download/v1.0.1/gotty_linux_amd64.tar.gz"

# === 1. PREPARE HOST INFO (NET & DISK) ===============================
echo "[1/7] Detecting Host Network & Disk..."

# Detect Network Interface
MAIN_IF=$(ip route get 1.1.1.1 | grep -oP 'dev \K\S+')
# Detect IP/CIDR (Example: 103.1.1.5/24)
HOST_IP_CIDR=$(ip -4 addr show "$MAIN_IF" | grep -oP '(?<=inet\s)\d+(\.\d+){3}/\d+' | head -n1)
# Detect Gateway
HOST_GW=$(ip route | grep default | awk '{print $3}' | head -n1)
# Detect Root Disk (Disk chứa phân vùng /)
ROOT_PART=$(findmnt -n / -o SOURCE)
# Lấy tên ổ đĩa gốc (vd: /dev/vda từ /dev/vda1)
HOST_DISK="/dev/$(lsblk -no pkname "$ROOT_PART" | head -n1)"

if [ -z "$HOST_IP_CIDR" ] || [ -z "$HOST_GW" ] || [ -z "$HOST_DISK" ]; then
    echo "ERROR: Could not detect Network or Disk info."
    echo "IP: $HOST_IP_CIDR, GW: $HOST_GW, DISK: $HOST_DISK"
    exit 1
fi

echo " -> Network: $HOST_IP_CIDR (GW: $HOST_GW)"
echo " -> Target Disk: $HOST_DISK"

# === 2. INSTALL HOST DEPS ============================================
echo "[2/7] Installing dependencies..."
export DEBIAN_FRONTEND=noninteractive
apt-get -y -qq update
apt-get -y -qq install wget curl gzip cpio kexec-tools tar --no-install-recommends

# === 3. PREPARE TINYCORE FILES =======================================
echo "[3/7] Downloading TinyCore & Tools..."
WORKDIR="/tmp/tc_build"
rm -rf "$WORKDIR" && mkdir -p "$WORKDIR/opt" "$WORKDIR/bin"

TCE_MIRROR="http://tinycorelinux.net/14.x/x86_64/release/distribution_files"
wget -q -O "$WORKDIR/vmlinuz64" "$TCE_MIRROR/vmlinuz64"
wget -q -O "$WORKDIR/corepure64.gz" "$TCE_MIRROR/corepure64.gz"

# Download GoTTY (Static binary)
echo " -> Downloading GoTTY..."
wget -q -O "$WORKDIR/gotty.tar.gz" "$GOTTY_URL"
tar -xzf "$WORKDIR/gotty.tar.gz" -C "$WORKDIR/bin/"
chmod +x "$WORKDIR/bin/gotty"
rm "$WORKDIR/gotty.tar.gz"

# === 4. UNPACK & INJECT INITRD =======================================
echo "[4/7] Injecting scripts into Initrd..."
mkdir -p "$WORKDIR/rootfs"
cd "$WORKDIR/rootfs"
gzip -dc "../corepure64.gz" | cpio -idmv >/dev/null 2>&1

# Copy GoTTY to rootfs
cp "$WORKDIR/bin/gotty" "$WORKDIR/rootfs/usr/local/bin/"

# Create bootlocal.sh
cat > "$WORKDIR/rootfs/opt/bootlocal.sh" <<'EOF'
#!/bin/sh
# --- TINYCORE BOOT SCRIPT ---
LOG="/tmp/install.log"
touch $LOG

# Helper to log
log() { echo "[$1] $2"; echo "[$1] $2" >> $LOG; }

# 1. Parse Kernel Cmdline for Configs
for x in $(cat /proc/cmdline); do
  case "$x" in
    tc_ip=*) MY_IP="${x#*=}" ;;
    tc_gw=*) MY_GW="${x#*=}" ;;
    tc_disk=*) MY_DISK="${x#*=}" ;;
    tc_img=*) IMG_URL="${x#*=}" ;;
  esac
done

# 2. Start GoTTY (Port 80, Read-only view of the log)
# Running in background so it doesn't block
log "GOTTY" "Starting Web Terminal on Port 80..."
/usr/local/bin/gotty -p 80 -w=false --title-format "TinyCore Installer" tail -f $LOG &

# 3. Configure Network (Static - Instant)
log "NET" "Configuring Static IP: $MY_IP"
ifconfig eth0 $MY_IP up
route add default gw $MY_GW
echo "nameserver 8.8.8.8" > /etc/resolv.conf
echo "nameserver 1.1.1.1" >> /etc/resolv.conf

# 4. Check Network
log "NET" "Checking connectivity..."
if wget -q --spider http://google.com; then
    log "NET" "Online! Ready to download."
else
    log "NET" "ERROR: No internet connection."
    log "NET" "Debug: $(ifconfig eth0)"
    log "NET" "Debug: $(route -n)"
    sleep 10
    reboot -f
fi

# 5. Prepare Disk
if [ ! -b "$MY_DISK" ]; then
    log "ERR" "Target disk $MY_DISK not found!"
    lsblk >> $LOG
    sleep 10
    reboot -f
fi

log "DISK" "Target: $MY_DISK"
log "DISK" "Unmounting partitions..."
umount ${MY_DISK}* 2>/dev/null || true
swapoff -a

# 6. Stream Install (Wget | Gunzip | DD)
log "INS" "Downloading & Writing Image..."
log "INS" "Source: $IMG_URL"

# Pipe with progress tracking via file size (rough estimate) or just generic wait
wget --no-check-certificate -O- "$IMG_URL" 2>>$LOG \
| gunzip -c \
| dd of="$MY_DISK" bs=4M conv=fsync 2>>$LOG

if [ $? -eq 0 ]; then
    log "DONE" "Installation Complete!"
    log "SYS" "Rebooting in 5 seconds..."
    sleep 5
    reboot -f
else
    log "ERR" "Pipeline failed. Check logs above."
    sleep 3600
fi
EOF

chmod +x "$WORKDIR/rootfs/opt/bootlocal.sh"

# Ensure bootlocal runs
echo "/opt/bootlocal.sh &" >> "$WORKDIR/rootfs/opt/bootsync.sh"

# === 5. REPACK INITRD ================================================
echo "[5/7] Repacking Initrd..."
find . | cpio -o -H newc | gzip -c > "$WORKDIR/corepure64-custom.gz"

# === 6. EXECUTE KEXEC ================================================
echo "[6/7] Preparing Kexec..."

# Construct Kernel Command Line with Host Variables
# tc_ip: CIDR format (e.g., 10.0.0.2/24) is supported by busybox ifconfig in some versions,
# but to be safe we rely on ip command if available, or ifconfig.
# TinyCore default ifconfig might need mask separately.
# Hack: Let's assume user has standard CIDR.
CMDLINE="console=ttyS0 quiet tc_ip=${HOST_IP_CIDR} tc_gw=${HOST_GW} tc_disk=${HOST_DISK} tc_img=${GZ_LINK}"

echo "---------------------------------------------"
echo "TARGET IP  : http://${HOST_IP_CIDR%/*}"
echo "TARGET DISK: ${HOST_DISK}"
echo "---------------------------------------------"
echo "WARNING: System will takeover in 3 seconds."
echo "Visit http://${HOST_IP_CIDR%/*} to view progress via GoTTY."
sleep 3

kexec -l "$WORKDIR/vmlinuz64" \
      --initrd="$WORKDIR/corepure64-custom.gz" \
      --command-line="$CMDLINE"

echo "[7/7] BOOM! Goodbye Linux..."
kexec -e
