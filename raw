#!/bin/bash
set -euo pipefail
# =====================================================================
# TinyCore Auto Windows Deployer v8-gotty-optimized
# IMPROVEMENTS:
# - GoTTY terminal sharing thay Discord webhook
# - K·∫ø th·ª´a network config t·ª´ host (IPv4 public)
# - Ch·ªçn target disk TR∆Ø·ªöC khi boot TinyCore (tr√°nh l·ªói ch·ªçn sai)
# - T·ªëi ∆∞u t·ªëc ƒë·ªô: song song download, gi·∫£m sleep, b·ªè packages kh√¥ng c·∫ßn
# =====================================================================

# === USER CONFIG =====================================================
GZ_LINK="https://is.gd/ZubYbG"   # Windows .img.gz URL
GOTTY_PORT="8080"                 # GoTTY web terminal port
SWAP_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/grubsdbuefiwin.gz"

# === AUTO-DETECT TARGET DISK (TR∆Ø·ªöC KHI BOOT TINYCORE) ==============
echo "=========================================="
echo "üîç Detecting boot disk..."
echo "=========================================="

# L·∫•y boot disk (disk ch·ª©a root filesystem hi·ªán t·∫°i)
BOOT_DISK=$(lsblk -ndo PKNAME $(findmnt -n -o SOURCE /) 2>/dev/null | head -1)
if [ -z "$BOOT_DISK" ]; then
    # Fallback: t√¨m disk c√≥ mount point /
    BOOT_DISK=$(lsblk -ndo PKNAME $(mount | grep ' / ' | awk '{print $1}') 2>/dev/null | head -1)
fi
if [ -z "$BOOT_DISK" ]; then
    # Fallback cu·ªëi: t√¨m disk ƒë·∫ßu ti√™n
    BOOT_DISK=$(lsblk -ndo NAME,TYPE | awk '$2=="disk"{print $1; exit}')
fi

TARGET_DISK="/dev/$BOOT_DISK"

echo "üéØ Boot disk found: $TARGET_DISK"
echo ""

# Hi·ªÉn th·ªã th√¥ng tin chi ti·∫øt
echo "üìä Current disk layout:"
echo "----------------------------------------"
lsblk "$TARGET_DISK" -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT,LABEL
echo "----------------------------------------"
echo ""

# Hi·ªÉn th·ªã t·∫•t c·∫£ disks ƒë·ªÉ user bi·∫øt
echo "üìÄ All available disks on system:"
lsblk -ndo NAME,SIZE,TYPE,MODEL | awk '$3=="disk"{print "  - /dev/"$1" ("$2") "$4}'
echo ""

echo "‚ÑπÔ∏è  This script will use the BOOT DISK: $TARGET_DISK"
echo "   (The disk where your current OS is running)"
echo ""
echo "‚ö†Ô∏è  WARNING: $TARGET_DISK will be completely wiped"
echo "   All data will be DESTROYED and replaced with Windows"
echo ""

# Bi·∫øn BOOT_DISK = TARGET_DISK (v√¨ ta ghi ƒë√® l√™n ch√≠nh disk ƒëang boot)
BOOT_DISK="$TARGET_DISK"

# === DETECT NETWORK CONFIG FROM HOST =================================
echo ""
echo "üåê Detecting network configuration..."

# L·∫•y interface c√≥ IPv4 public (kh√¥ng ph·∫£i 127.0.0.1, 10.x, 172.16-31.x, 192.168.x)
HOST_IP=$(ip -4 addr show | grep -oP 'inet \K[\d.]+' | grep -v '^127\.' | grep -Ev '^10\.|^172\.(1[6-9]|2[0-9]|3[0-1])\.|^192\.168\.' | head -1)
HOST_GW=$(ip route | grep default | awk '{print $3}' | head -1)
HOST_NIC=$(ip route get 8.8.8.8 | grep -oP 'dev \K\S+' | head -1)

# Fallback n·∫øu kh√¥ng t√¨m th·∫•y IP public
[ -z "$HOST_IP" ] && HOST_IP=$(ip -4 addr show | grep -oP 'inet \K[\d.]+' | grep -v '^127\.' | head -1)
[ -z "$HOST_NIC" ] && HOST_NIC="eth0"
[ -z "$HOST_GW" ] && HOST_GW="$(echo $HOST_IP | cut -d. -f1-3).1"

echo "üì° Interface: $HOST_NIC"
echo "üìç IP: $HOST_IP"
echo "üö™ Gateway: $HOST_GW"

# L·∫•y nameserver
HOST_DNS=$(grep -m1 '^nameserver' /etc/resolv.conf | awk '{print $2}')
[ -z "$HOST_DNS" ] && HOST_DNS="1.1.1.1"
echo "üîç DNS: $HOST_DNS"

# === TINYCORE SETUP ==================================================
TCE_VERSION="14.x"
ARCH="x86_64"
TCE_MIRROR="http://tinycorelinux.net"
BOOT_DIR="/boot/tinycore"
WORKDIR="/tmp/tinycore_initrd"
KERNEL_URL="$TCE_MIRROR/$TCE_VERSION/$ARCH/release/distribution_files/vmlinuz64"
INITRD_URL="$TCE_MIRROR/$TCE_VERSION/$ARCH/release/distribution_files/corepure64.gz"
KERNEL_PATH="$BOOT_DIR/vmlinuz64"
INITRD_PATH="$BOOT_DIR/corepure64.gz"
INITRD_PATCHED="$BOOT_DIR/corepure64-v8-optimized.gz"
BUSYBOX_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/busybox"
GOTTY_URL="https://github.com/yudai/gotty/releases/download/v1.0.1/gotty_linux_amd64.tar.gz"

export DEBIAN_FRONTEND=noninteractive
export NEEDRESTART_MODE=a

echo ""
echo "[1/6] Installing dependencies..."
apt-get -y -qq update
apt-get -y -qq install wget curl gzip cpio kexec-tools ca-certificates --no-install-recommends

mkdir -p "$BOOT_DIR" "$WORKDIR"

echo "[2/6] Downloading TinyCore kernel & initrd..."
wget -q --show-progress -O "$KERNEL_PATH" "$KERNEL_URL" &
wget -q --show-progress -O "$INITRD_PATH" "$INITRD_URL" &
wait  # Download song song

echo "[3/6] Unpacking initrd..."
cd "$WORKDIR"
gzip -dc "$INITRD_PATH" | cpio -idm 2>/dev/null

echo "[4/6] Injecting deployment script..."
mkdir -p "$WORKDIR/srv" "$WORKDIR/opt"

# Download BusyBox & GoTTY
wget -q -O "$WORKDIR/srv/busybox" "$BUSYBOX_URL"
chmod +x "$WORKDIR/srv/busybox"

wget -q -O /tmp/gotty.tar.gz "$GOTTY_URL"
tar -xzf /tmp/gotty.tar.gz -C "$WORKDIR/srv/" gotty
chmod +x "$WORKDIR/srv/gotty"

# === BOOTLOCAL.SH (OPTIMIZED) ========================================
cat > "$WORKDIR/opt/bootlocal.sh" <<'EOFS'
#!/bin/sh
IMAGE_URL="__TC_GZ_LINK__"
TARGET_DISK="__TC_TARGET_DISK__"
BOOT_DISK="__TC_BOOT_DISK__"
SWAP_URL="__TC_SWAP_URL__"
GOTTY_PORT="__TC_GOTTY_PORT__"
HOST_IP="__TC_HOST_IP__"
HOST_GW="__TC_HOST_GW__"
HOST_NIC="__TC_HOST_NIC__"
HOST_DNS="__TC_HOST_DNS__"

exec > /tmp/deploy.log 2>&1
tail -f /tmp/deploy.log &

echo "=========================================="
echo "üöÄ TinyCore v8 - GoTTY Optimized Deployer"
echo "=========================================="
echo "Target: $TARGET_DISK | Boot: $BOOT_DISK"
echo "Network: $HOST_IP via $HOST_NIC"
date

# === NETWORK SETUP (K·∫æ TH·ª™A T·ª™ HOST) ================================
echo ""
echo "[NET] Configuring network from host..."
ip link set lo up
ip link set "$HOST_NIC" up

# Static IP t·ª´ host
ip addr add "$HOST_IP/24" dev "$HOST_NIC" 2>/dev/null || \
ip addr add "$HOST_IP/16" dev "$HOST_NIC"

ip route add default via "$HOST_GW" dev "$HOST_NIC" 2>/dev/null
echo "nameserver $HOST_DNS" > /etc/resolv.conf

echo "[NET] Testing connectivity..."
if ping -c 2 -W 3 8.8.8.8 >/dev/null 2>&1; then
    echo "[NET] ‚úì Internet OK"
else
    echo "[NET] ‚úó No internet! Check network config"
fi

# === START GOTTY =====================================================
echo ""
echo "[GOTTY] Starting web terminal on :$GOTTY_PORT..."
echo "[GOTTY] Access: http://$HOST_IP:$GOTTY_PORT/"

/srv/gotty -w -p "$GOTTY_PORT" --permit-write \
    --title-format "TinyCore Deployer - {{ .Hostname }}" \
    /bin/sh -c "tail -f /tmp/deploy.log" &

sleep 2
echo "[GOTTY] ‚úì Terminal sharing active"

# === MINIMAL PACKAGES (CH·ªà C·∫¶N THI·∫æT) ===============================
echo ""
echo "[PKG] Loading essential packages..."
for pkg in ca-certificates openssl curl; do
    su tc -c "tce-load -wi $pkg" >/dev/null 2>&1 || echo "[PKG] Warning: $pkg failed"
done

# === DISK PREPARATION ===============================================
echo ""
echo "[DISK] Preparing $TARGET_DISK..."

# Unmount all partitions
for part in $(lsblk -lno NAME "$TARGET_DISK" | tail -n+2); do
    umount -f "/dev/$part" 2>/dev/null || true
done

# Quick wipe MBR/GPT (kh√¥ng c·∫ßn wipe to√†n b·ªô)
dd if=/dev/zero of="$TARGET_DISK" bs=1M count=10 conv=fsync 2>/dev/null
sync

echo "[DISK] ‚úì Ready"

# === DOWNLOAD & DEPLOY IMAGE (OPTIMIZED) ============================
echo ""
echo "[IMG] Streaming image to $TARGET_DISK..."
echo "[IMG] Source: $IMAGE_URL"
echo "[IMG] Started: $(date)"

START_TIME=$(date +%s)

# Stream: wget -> gunzip -> dd (bs=8M cho t·ªëc ƒë·ªô t·ªët h∆°n)
wget --no-check-certificate -O- "$IMAGE_URL" 2>/tmp/wget.log | \
    gunzip -c | \
    dd of="$TARGET_DISK" bs=8M conv=fsync status=progress 2>&1 | \
    while read line; do
        echo "[DD] $line"
    done

RC=$?
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

if [ "$RC" -ne 0 ]; then
    echo "[ERR] Deployment failed! Exit code: $RC"
    echo "[ERR] Last wget errors:"
    tail -20 /tmp/wget.log
    sleep 30
    reboot -f
fi

echo "[IMG] ‚úì Completed in ${DURATION}s"

sync
partprobe "$TARGET_DISK" 2>/dev/null || true

# === BOOTFIX (N·∫æU C·∫¶N) ==============================================
if [ "$BOOT_DISK" != "$TARGET_DISK" ] && [ -n "$SWAP_URL" ]; then
    echo ""
    echo "[BOOT] Applying bootfix to $BOOT_DISK..."
    
    if wget --no-check-certificate -O /tmp/grub.gz "$SWAP_URL" 2>/dev/null; then
        gunzip -c /tmp/grub.gz | dd of="$BOOT_DISK" bs=4M conv=fsync 2>/dev/null
        sync
        echo "[BOOT] ‚úì MBR/bootsector written"
    else
        echo "[BOOT] ‚úó Bootfix download failed"
    fi
else
    echo "[BOOT] Bootfix skipped (not needed)"
fi

# === DONE ===========================================================
echo ""
echo "=========================================="
echo "‚úÖ DEPLOYMENT COMPLETE"
echo "=========================================="
echo "Duration: ${DURATION}s"
echo "Target: $TARGET_DISK"
lsblk "$TARGET_DISK" -o NAME,SIZE,TYPE
echo ""
echo "Rebooting in 10 seconds..."
echo "GoTTY will remain accessible until reboot"

sleep 10
reboot -f
EOFS

# === INJECT VARIABLES ================================================
sed -i "s|__TC_GZ_LINK__|$GZ_LINK|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_TARGET_DISK__|$TARGET_DISK|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_BOOT_DISK__|$BOOT_DISK|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_SWAP_URL__|$SWAP_URL|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_GOTTY_PORT__|$GOTTY_PORT|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_IP__|$HOST_IP|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_GW__|$HOST_GW|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_NIC__|$HOST_NIC|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_DNS__|$HOST_DNS|g" "$WORKDIR/opt/bootlocal.sh"

chmod +x "$WORKDIR/opt/bootlocal.sh"

# Autorun bootlocal.sh
grep -q "/opt/bootlocal.sh" "$WORKDIR/etc/init.d/tc-config" 2>/dev/null || \
    echo "/opt/bootlocal.sh &" >> "$WORKDIR/etc/init.d/tc-config"

echo "[5/6] Repacking initrd..."
find . | cpio -o -H newc 2>/dev/null | gzip -1 > "$INITRD_PATCHED"

echo "[6/6] Booting TinyCore via kexec..."
CMDLINE="console=tty0 quiet host_ip=$HOST_IP host_gw=$HOST_GW"

kexec -l "$KERNEL_PATH" \
    --initrd="$INITRD_PATCHED" \
    --command-line="$CMDLINE"

echo ""
echo "=========================================="
echo "‚úÖ Ready to boot!"
echo "=========================================="
echo "üåê GoTTY will be available at:"
echo "   http://$HOST_IP:$GOTTY_PORT/"
echo ""
echo "üìä Monitor deployment progress there"
echo "üéØ Target disk: $TARGET_DISK"
echo "‚è±Ô∏è  ETA: ~5-15 minutes depending on image size"
echo ""
echo "Executing kexec in 3 seconds..."
sleep 3

kexec -e
