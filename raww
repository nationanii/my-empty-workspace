#!/bin/bash
set -euo pipefail

# =====================================================================
# TinyCore Auto Windows Deployer v8-gotty-optimized (CLEANED)
# =====================================================================

# === USER CONFIG =====================================================
GZ_LINK="https://148.100.76.25:3923/WindowsCustom.gz"   # Link file .gz
GOTTY_PORT="8080"                                       # Port web terminal
SWAP_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/grubsdbuefiwin.gz" # Grub fix (n·∫øu c·∫ßn)
FINDHD="false"                                          # Format ·ªï ƒëƒ©a ph·ª• (true/false)

# =====================================================================
# GIAI ƒêO·∫†N 1: HOST DETECTION (CH·∫†Y TR√äN OS HI·ªÜN T·∫†I)
# =====================================================================

echo "=========================================="
echo "üîç Detecting boot disk..."
echo "=========================================="

# 1. Ph√°t hi·ªán Disk
BOOT_DISK=$(lsblk -ndo PKNAME $(findmnt -n -o SOURCE /) 2>/dev/null | head -1)
if [ -z "$BOOT_DISK" ]; then
    BOOT_DISK=$(lsblk -ndo PKNAME $(mount | grep ' / ' | awk '{print $1}') 2>/dev/null | head -1)
fi
if [ -z "$BOOT_DISK" ]; then
    BOOT_DISK=$(lsblk -ndo NAME,TYPE | awk '$2=="disk"{print $1; exit}')
fi

TARGET_DISK="/dev/$BOOT_DISK"
echo "üéØ Boot disk found: $TARGET_DISK"

echo "üìä Current disk layout:"
lsblk "$TARGET_DISK" -o NAME,SIZE,TYPE,FSTYPE,MOUNTPOINT,LABEL
echo ""
echo "‚ö†Ô∏è  WARNING: $TARGET_DISK will be completely wiped!"
echo ""

# 2. Ph√°t hi·ªán Network
echo "üåê Detecting network configuration..."
HOST_NIC=$(ip route show default | head -1 | grep -oP 'dev \K\S+')
[ -z "$HOST_NIC" ] && HOST_NIC=$(ip -o link show | awk -F': ' '$2!="lo"{print $2; exit}')
[ -z "$HOST_NIC" ] && HOST_NIC="eth0"

HOST_IP=$(ip -4 addr show dev "$HOST_NIC" | grep -oP 'inet \K[\d.]+' | head -1)
[ -z "$HOST_IP" ] && HOST_IP=$(ip -4 addr show | grep -oP 'inet \K[\d.]+' | grep -v '^127\.' | head -1)

HOST_GW=$(ip route show default | head -1 | awk '{print $3}')
if [ -z "$HOST_GW" ]; then
    HOST_GW="$(echo $HOST_IP | cut -d. -f1-3).1"
fi

HOST_CIDR=$(ip -4 addr show dev "$HOST_NIC" | grep -oP 'inet [\d.]+/\K\d+' | head -1)
[ -z "$HOST_CIDR" ] && HOST_CIDR="24"

HOST_DNS=$(grep -m1 '^nameserver' /etc/resolv.conf | awk '{print $2}')
[ -z "$HOST_DNS" ] && HOST_DNS="1.1.1.1"

# 3. Detect Public IP
echo "üîç Detecting public IPv4..."
PUBLIC_IP=$(timeout 2 curl -s http://169.254.169.254/latest/meta-data/public-ipv4 2>/dev/null || true)
[ -z "$PUBLIC_IP" ] && PUBLIC_IP=$(timeout 3 curl -s https://ifconfig.me 2>/dev/null || true)
[ -z "$PUBLIC_IP" ] && PUBLIC_IP="$HOST_IP"

echo "üì° Interface: $HOST_NIC"
echo "üìç Local IP:  $HOST_IP/$HOST_CIDR"
echo "üåç Public IP: $PUBLIC_IP"
echo "üö™ Gateway:   $HOST_GW"

# =====================================================================
# GIAI ƒêO·∫†N 2: PREPARE TINYCORE ENVIRONMENT
# =====================================================================

TCE_VERSION="14.x"
ARCH="x86_64"
TCE_MIRROR="http://tinycorelinux.net"
BOOT_DIR="/boot/tinycore"
WORKDIR="/tmp/tinycore_initrd"
KERNEL_URL="$TCE_MIRROR/$TCE_VERSION/$ARCH/release/distribution_files/vmlinuz64"
INITRD_URL="$TCE_MIRROR/$TCE_VERSION/$ARCH/release/distribution_files/corepure64.gz"
KERNEL_PATH="$BOOT_DIR/vmlinuz64"
INITRD_PATH="$BOOT_DIR/corepure64.gz"
INITRD_PATCHED="$BOOT_DIR/corepure64-v8-optimized.gz"
BUSYBOX_URL="https://raw.githubusercontent.com/lt4c/stuff/refs/heads/main/busybox"
TTYD_URL="https://github.com/tsl0922/ttyd/releases/download/1.7.7/ttyd.x86_64"

export DEBIAN_FRONTEND=noninteractive

echo ""
echo "[1/6] Installing dependencies..."
apt-get -y -qq update
apt-get -y -qq install wget curl gzip cpio kexec-tools ca-certificates --no-install-recommends

mkdir -p "$BOOT_DIR" "$WORKDIR"

echo "[2/6] Downloading TinyCore kernel & initrd..."
wget -q --show-progress -O "$KERNEL_PATH" "$KERNEL_URL" &
wget -q --show-progress -O "$INITRD_PATH" "$INITRD_URL" &
wait

echo "[3/6] Unpacking initrd..."
cd "$WORKDIR"
gzip -dc "$INITRD_PATH" | cpio -idm 2>/dev/null

echo "[4/6] Injecting tools..."
mkdir -p "$WORKDIR/srv" "$WORKDIR/opt"
wget -q -O "$WORKDIR/srv/busybox" "$BUSYBOX_URL" && chmod +x "$WORKDIR/srv/busybox"
wget -q -O "$WORKDIR/srv/ttyd" "$TTYD_URL" && chmod +x "$WORKDIR/srv/ttyd"

# =====================================================================
# GIAI ƒêO·∫†N 3: CREATE BOOTLOCAL.SH (RUNTIME SCRIPT)
# =====================================================================
# Script n√†y s·∫Ω ch·∫°y B√äN TRONG TinyCore sau khi reboot
cat > "$WORKDIR/opt/bootlocal.sh" <<'EOFS'
#!/bin/sh
# --- Variables injected by sed ---
IMAGE_URL="__TC_GZ_LINK__"
TARGET_DISK="__TC_TARGET_DISK__"
BOOT_DISK="__TC_BOOT_DISK__"
SWAP_URL="__TC_SWAP_URL__"
GOTTY_PORT="__TC_GOTTY_PORT__"
HOST_IP="__TC_HOST_IP__"
HOST_GW="__TC_HOST_GW__"
HOST_NIC="__TC_HOST_NIC__"
HOST_DNS="__TC_HOST_DNS__"
PUBLIC_IP="__TC_PUBLIC_IP__"
FINDHD="__TC_FINDHD__"

# --- Logging Setup ---
touch /tmp/deploy.log
exec >> /tmp/deploy.log 2>&1
echo "üöÄ TinyCore Deployer Started at $(date)"
echo "Target: $TARGET_DISK | IP: $HOST_IP"

# --- Network Setup ---
echo "[NET] Configuring network..."
ip link set lo up
# TinyCore th∆∞·ªùng nh·∫≠n eth0 l√† interface ch√≠nh
ip link set eth0 up 2>/dev/null
ip link set "$HOST_NIC" up 2>/dev/null

ip addr add "$HOST_IP/24" dev "$HOST_NIC" 2>/dev/null || ip addr add "$HOST_IP/24" dev eth0
ip route add default via "$HOST_GW" 2>/dev/null
echo "nameserver $HOST_DNS" > /etc/resolv.conf

# --- Start TTYD Web Terminal ---
echo "[TTYD] Starting web terminal..."
cat > /tmp/ttyd_wrapper.sh <<'WRAPPER'
#!/bin/sh
while true; do
    if [ -f /tmp/deploy.log ]; then tail -f /tmp/deploy.log; else echo "Waiting..."; sleep 1; fi
done
WRAPPER
chmod +x /tmp/ttyd_wrapper.sh

/srv/ttyd -p "$GOTTY_PORT" -i 0.0.0.0 -t fontSize=14 /tmp/ttyd_wrapper.sh &

# --- Load Packages ---
echo "[PKG] Loading extensions..."
tce-load -wi ca-certificates openssl curl parted gdisk >/dev/null 2>&1

# --- Disk Wipe ---
echo "[DISK] Wiping $TARGET_DISK..."
umount -f "${TARGET_DISK}"* 2>/dev/null
dd if=/dev/zero of="$TARGET_DISK" bs=1M count=10 conv=fsync 2>/dev/null
sync

# --- Download & Flash ---
echo "[IMG] Streaming image from $IMAGE_URL..."
START_TIME=$(date +%s)

wget --no-check-certificate -S -O- "$IMAGE_URL" 2>>/tmp/deploy.log \
  | gunzip -c \
  | dd of="$TARGET_DISK" bs=4M conv=fsync 2>>/tmp/deploy.log

RC=$?
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

if [ "$RC" -ne 0 ]; then
    echo "[ERR] Image write failed!"
    sleep 60
    reboot -f
fi

echo "[IMG] Completed in ${DURATION}s"
sync
partprobe "$TARGET_DISK" 2>/dev/null

# --- Post-Install: Delete Recovery & Expand C: ---
echo "[DISK] Optimizing partitions..."

# 1. T√¨m v√† x√≥a Recovery Partition
RECOVERY_PART=""
for part in ${TARGET_DISK}*[0-9]; do
    [ -b "$part" ] || continue
    LABEL=$(/srv/busybox blkid "$part" 2>/dev/null | grep -oP 'LABEL="\K[^"]+' || echo "")
    if echo "$LABEL" | grep -qi "recovery\|winre"; then
        RECOVERY_PART="$part"
        break
    fi
done

if [ -n "$RECOVERY_PART" ]; then
    echo "[DISK] Deleting Recovery: $RECOVERY_PART"
    PART_NUM=$(echo "$RECOVERY_PART" | grep -oE '[0-9]+$')
    
    if command -v gdisk >/dev/null 2>&1; then
        echo -e "d\n$PART_NUM\nw\ny" | gdisk "$TARGET_DISK" 2>/dev/null
    else
        echo -e "d\n$PART_NUM\nw" | fdisk "$TARGET_DISK" 2>/dev/null
    fi
    sync
    partprobe "$TARGET_DISK" 2>/dev/null
fi

# 2. M·ªü r·ªông partition cu·ªëi c√πng (C:)
LAST_PART=$(ls ${TARGET_DISK}*[0-9] 2>/dev/null | tail -1)
if [ -n "$LAST_PART" ]; then
    PART_NUM=$(echo "$LAST_PART" | grep -oE '[0-9]+$')
    echo "[DISK] Expanding partition $PART_NUM on $TARGET_DISK"
    if command -v parted >/dev/null 2>&1; then
        parted "$TARGET_DISK" resizepart "$PART_NUM" 100% 2>/dev/null
    fi
fi

# --- Optional: FINDHD (Format other disks) ---
if [ "$FINDHD" = "true" ]; then
    echo "[FINDHD] Formatting additional disks..."
    ALL_DISKS=$(fdisk -l 2>/dev/null | grep -E "^Disk /dev/" | awk '{print $2}' | tr -d ':')
    for disk in $ALL_DISKS; do
        [ "$disk" = "$TARGET_DISK" ] && continue
        [ -b "$disk" ] || continue
        
        echo "[FINDHD] Formatting $disk (NTFS)"
        dd if=/dev/zero of="$disk" bs=1M count=10 2>/dev/null
        if command -v parted >/dev/null 2>&1; then
            parted -s "$disk" mklabel gpt
            parted -s "$disk" mkpart primary ntfs 0% 100%
        fi
    done
fi

# --- Bootfix (VPS Special Case) ---
if [ "$BOOT_DISK" != "$TARGET_DISK" ] && [ -n "$SWAP_URL" ]; then
    echo "[BOOT] Writing boot sector to $BOOT_DISK..."
    wget --no-check-certificate -O- "$SWAP_URL" 2>/dev/null | gunzip -c | dd of="$BOOT_DISK" bs=4M 2>/dev/null
fi

echo "‚úÖ DEPLOYMENT SUCCESS! Rebooting in 10s..."
sleep 10
reboot -f
EOFS

# =====================================================================
# GIAI ƒêO·∫†N 4: INJECT VARIABLES & REPACK
# =====================================================================

# Inject Host Variables into TinyCore script
sed -i "s|__TC_GZ_LINK__|$GZ_LINK|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_TARGET_DISK__|$TARGET_DISK|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_BOOT_DISK__|$BOOT_DISK|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_SWAP_URL__|$SWAP_URL|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_GOTTY_PORT__|$GOTTY_PORT|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_IP__|$HOST_IP|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_GW__|$HOST_GW|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_NIC__|$HOST_NIC|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_HOST_DNS__|$HOST_DNS|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_PUBLIC_IP__|$PUBLIC_IP|g" "$WORKDIR/opt/bootlocal.sh"
sed -i "s|__TC_FINDHD__|$FINDHD|g" "$WORKDIR/opt/bootlocal.sh"

chmod +x "$WORKDIR/opt/bootlocal.sh"

# Ensure startup
if ! grep -q "bootlocal_executed" "$WORKDIR/etc/init.d/tc-config" 2>/dev/null; then
    cat >> "$WORKDIR/etc/init.d/tc-config" <<'TCCONFIG'
if [ ! -f /tmp/bootlocal_executed ]; then
    touch /tmp/bootlocal_executed
    /opt/bootlocal.sh &
fi
TCCONFIG
fi

echo "[5/6] Repacking initrd..."
find . | cpio -o -H newc 2>/dev/null | gzip -1 > "$INITRD_PATCHED"

# =====================================================================
# GIAI ƒêO·∫†N 5: EXECUTE KEXEC
# =====================================================================

echo "[6/6] Booting TinyCore via kexec..."
CMDLINE="console=tty0 quiet host_ip=$HOST_IP host_gw=$HOST_GW"

kexec -l "$KERNEL_PATH" \
    --initrd="$INITRD_PATCHED" \
    --command-line="$CMDLINE"

echo ""
echo "=========================================="
echo "‚úÖ READY TO BOOT"
echo "=========================================="
echo "üåê Monitor via: http://$PUBLIC_IP:$GOTTY_PORT/"
echo "‚è±Ô∏è  Deployment will start automatically after reboot."
echo "Executing kexec in 3 seconds..."
sleep 3

kexec -e
